name: Renovate
on:
  # Allows manual/automated ad-hoc trigger
  workflow_dispatch:
    inputs:
      logLevel:
        description: Override default log level
        required: false
        default: debug
        type: string
      overrideSchedule:
        description: Ignores schedules and merge/commit everything now
        default: false
        type: boolean

  workflow_call:
    inputs:
      logLevel:
        description: Log level
        default: warn
        type: string

      overrideSchedule:
        description: Ignores schedules and merge/commit everything now
        default: false
        type: boolean

  # Whenever we change this file in our main branch
  push:
    branches:
      - main
    paths:
      - .github/renovate.json5
      - .github/workflows/renovate.yaml

  # Run twice in the early morning for initial and follow up steps (create pull request and merge)
  schedule:
    # NOTE: We run this "first" in the grand scheme of images, web and infrastructure
    - cron: 15,45 1 * * * # IMPORTANT: Any renovate auto scheduling periods should be within this time!!!!

concurrency: renovate

jobs:
  renovate:
    runs-on: ubuntu-latest
    steps:
      # IMPORTANT: Renovate works "weirdly" as it pulls repositories to work on itself, so it will clone RENOVATE_REPOSITORIES
      # itself using the token. This means it is also hard to test locally.
      - uses: renovatebot/github-action@v43.0.17
        env:
          LOG_LEVEL: ${{ inputs.logLevel || 'warn' }} # The or sets the log level for cron runs
          RENOVATE_REPOSITORIES: ${{ github.repository }} # Just target ourself
          RENOVATE_GIT_AUTHOR: "Renovate Bot <bot@renovateapp.com>"
          RENOVATE_BINARY_SOURCE: install # We want to automatically use third party dependencies like Flux!
          RENOVATE_FORCE: ${{ github.event.inputs.overrideSchedule == 'true' && '{''schedule'':null,''automergeSchedule'':null}' || '' }}
          RENOVATE_X_DOCKER_HUB_TAGS_DISABLE: "true" # Ensure to use normal Docker API for docker registry to avoid authentication issues.
          # Let's move some common settings (that we can) here so we don't have to add these to each renovate.json5
          RENOVATE_PLATFORM_AUTOMERGE: false
          RENOVATE_ONBOARDING: "false" # We do not care about onboarding as all is setup
          RENOVATE_REBASE_WHEN: behind-base-branch
          RENOVATE_RECREATE_WHEN: always
          RENOVATE_HOST_RULES: >-
            [
              {
                "hostType": "docker",
                "matchHost": "docker.io",
                "username": "kevinvalk",
                "password": "${{ secrets.DOCKERHUB_TOKEN }}"
              },
              {
                "hostType": "docker",
                "matchHost": "ghcr.io",
                "username": "kevinvalk",
                "password": "${{ secrets.RENOVATE_TOKEN }}"
              }
            ]
        with:
          token: ${{ secrets.RENOVATE_TOKEN }}
